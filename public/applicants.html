<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applicants</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .scrollable-table {
            height: 400px;
            overflow-y: auto;
            display: block;
        }
        #noDataMessage {
            display: none;
            font-size: 18px;
            color: red;
        }
        .toast {
            position: fixed;
            top: 0px; 
            background-color: #f44336;
            color: white;
            padding: 16px;
            border-radius: 5px;
            z-index: 1000;
        }

    </style>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-primary d-flex">
        <div>
            <a class="navbar-brand text-light" href="#" style="font-weight: bold;">Admin</a>
        </div>
              
        <div class="collapse navbar-collapse" id="navbarTogglerDemo02">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <li class="nav-item active">
              <a class="nav-link text-light" style="font-weight: bold;" href="/applicants-page">Applicants</a>
            <!-- <li class="nav-item active">
                <a class="nav-link text-light" href="/dashboard"  style="font-weight: bold;">Expiry users <span class="sr-only">(current)</span></a>
            </li> -->
            <li class="nav-item active">
                <a class="nav-link text-light" href="/payment.html"  style="font-weight: bold;">Payments <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link text-light" href="/expiry-user.html"  style="font-weight: bold;">Today <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link text-light" href="/pending.html"  style="font-weight: bold;">Investment Amount <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link text-light" href="/alldues.html"  style="font-weight: bold;">Paid <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link text-light" href="/change-bank.html"  style="font-weight: bold;">Update Account <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item active">
                <a class="nav-link text-light" href="/unpaid.html"  style="font-weight: bold;">Unpaid Users<span class="sr-only">(current)</span></a>
            </li>
          </ul>
         
          <!-- <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="search" placeholder="Search">
            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
          </form> -->
        </div>
        <div>
            <ul class="navbar-nav mt-2 mt-lg-0 text-primary" >
                <li class="nav-item active" >
                    <a class="nav-link text-light" onclick="logout()" style="cursor: pointer;font-weight: bold;">logout</a>
                </li>
              </ul>
        </div>
        <div>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo02" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon">        </span>
            </button> 
        </div>
      </nav>
      
      <section>
        <br>
    <h1>Applicants</h1>
    <div id="noDataMessage">No data is present</div>

    <div class="scrollable-table">
        <table id="applicantsTable">
            <thead>
                <tr>
                    <th>Serial No</th>
                    <th>Application No</th>
                    <th>Application Purchasing Date</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Email</th>
                    <th>Date of Birth</th>
                    <th>Phone Number</th>
                    <th>Agreement Start Date</th>
                    <th>Agreement End date</th>
                    <th>LockIN Free Date</th>
                    <th>Due Date</th>
                    <th>Whatsapp Number</th>
                    <th>Pan Card Number</th>
                    <th>Aadhaar Number</th>
                    <th>Current Address</th>
                    <th>Landmark</th>
                    <th>Area</th>
                    <th>Pin Code</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Country</th>
                    <th>Permanent Address Same as Current Address</th>
                    <th>Permanent Address</th>
                    <th>Foreign National</th>
                    <th>PEP Status</th>
                    <th>Bank Name</th>
                    <th>Account Number</th>
                    <th>MICR</th>
                    <th>IFSC Code</th>
                    <th>Account Type</th>
                    <th>Branch Address</th>
                    <th>Nominee Name</th>
                    <th>Nominee DOB</th>
                    <th>Nominee Gender</th>
                    <th>Nominee Relationship</th>
                    <th>Nominee Phone Number</th>
                    <th>Appointee Name</th>
                    <th>Appointee Relationship</th>
                    <th>Payment Mode</th>
                    <th>Invested Amount</th>
                    <th>Plan Selection</th>
                    <th>Income Option</th>
                    <th>Scheme Name</th>
                    <th>Tenure</th>
                    <th>lock In</th>
                    <th>Interest</th>
                    <th>Loyality Bonus</th>
                    <th>LockIn Free date</th>
                    <th>Payor Name</th>
                    <th>Payor Relationship</th>
                    <th>Payor Phone no</th>
                    <th>Payor Email</th>
                    <th>Online Agreement opt option</th>
                    <th>withness Name</th>
                    <th>Withness Relationship</th>
                    <th>Withness Address</th>
                    <th>Withness Landmark</th>
                    <th>Withness Pincode</th>
                    <th>Withness City</th>
                    <th>Withness State</th>
                    <th>Withness Country</th>
                    <th>Agreement Term & Condition Accepted</th>
                    <th>Status</th>
                    <th>Installments</th>
                </tr>
            </thead>
            <tbody>
                <!-- Table rows will be inserted here dynamically -->
            </tbody>
        </table>
    </div>
    <br>
    <button onclick="downloadExcel()">Download Excel</button>
    <div id="pagination" style="display: none;">
        <button id="prevPage" disabled>Previous</button>
        <span id="pageInfo"></span>
        <button id="nextPage">Next</button>
    </div>
</section>


    <script>
         let currentPage = 1;
         const limit = 10; 
        // Function to show toast notification
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.textContent = message;
    document.body.appendChild(toast);

    // Remove the toast after 3 seconds
    setTimeout(() => {
        toast.remove();
    }, 3000);
}
function logout() {
    fetch('/logout', {
        method: 'POST',
        credentials: 'include' // Include cookies for session
    })
    .then(response => {
        if (response.ok) {
            showToast('logout successfully');
            window.location.href = '/login'; // Redirect to the login page
        }
    })
    .catch(error => console.error('Error logging out:', error));
}









// Function to handle the logic and set scheme details based on conditions
function getSchemeDetails(planSelection, subscriptionOption) {
    let schemeName = '';
    let tenure = '';
    let lockIn = '';
    let interest = '';
    let loyaltyBonus = '';

    // Define the conditions and their respective values
    const conditions = {
        'A': {
            'monthly': { schemeName: 'ELITE EXECUTIVE', tenure: '5 YEARS', lockIn: '5 YEARS', interest: '11%', loyaltyBonus: '0%' },
            'quarterly': { schemeName: 'ELITE EXECUTIVE', tenure: '5 YEARS', lockIn: '5 YEARS', interest: '11%', loyaltyBonus: '0%' },
            'halfyearly': { schemeName: 'ELITE EXECUTIVE', tenure: '5 YEARS', lockIn: '5 YEARS', interest: '11%', loyaltyBonus: '0%' },
            'yearly': { schemeName: 'ELITE EXECUTIVE', tenure: '5 YEARS', lockIn: '5 YEARS', interest: '11%', loyaltyBonus: '1%' }
        },
        'B': {
            'monthly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '5 YEARS', lockIn: '3 YEARS', interest: '10%', loyaltyBonus: '0%' },
            'quarterly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '5 YEARS', lockIn: '3 YEARS', interest: '10%', loyaltyBonus: '0%' },
            'halfyearly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '5 YEARS', lockIn: '3 YEARS', interest: '10%', loyaltyBonus: '0%' },
            'yearly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '5 YEARS', lockIn: '3 YEARS', interest: '10%', loyaltyBonus: '1%' }
        },
        'D': {
            'quarterly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '3 YEARS', lockIn: '1 YEAR', interest: '10%', loyaltyBonus: '2%' },
            'halfyearly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '3 YEARS', lockIn: '1 YEAR', interest: '10%', loyaltyBonus: '2%' },
            'yearly': { schemeName: 'ELITE EXECUTIVE PRO', tenure: '3 YEARS', lockIn: '1 YEAR', interest: '10%', loyaltyBonus: '2%' }
        }
    };

    // Get the appropriate details based on planSelection and subscriptionOption
    if (conditions[planSelection] && conditions[planSelection][subscriptionOption]) {
        const schemeDetails = conditions[planSelection][subscriptionOption];
        schemeName = schemeDetails.schemeName;
        tenure = schemeDetails.tenure;
        lockIn = schemeDetails.lockIn;
        interest = schemeDetails.interest;
        loyaltyBonus = schemeDetails.loyaltyBonus;
    }

    return { schemeName, tenure, lockIn, interest, loyaltyBonus };
}










// Fetch applicants data
fetch('/applicants')
    .then(response => {
        if (response.status === 403) {
            showToast('You are not authorized, please login first.');
            window.location.href = '/login'; // Redirect to login
            return;
        }
        return response.json();
    })
    .then(data => {
        const tableBody = document.querySelector('#applicantsTable tbody');
        const noDataMessage = document.getElementById('noDataMessage');

        // Clear previous data
        tableBody.innerHTML = '';

        if (data.length === 0) {
            noDataMessage.style.display = 'block'; // Show the no data message
        } else {
            noDataMessage.style.display = 'none'; // Hide no data message
            data.forEach((applicant,index) => {
                const row = document.createElement('tr');



                const { schemeName, tenure, lockIn, interest, loyaltyBonus } = getSchemeDetails(applicant.planSelection, applicant.subscriptionOption);



                 // Attach the onclick event listener to each row
                        row.onclick = function() {
                            handleRowClick(applicant);
                            debugger
                            console.log(applicant)
                            window.location.href = `/applicant/${index+1}/installments`; // Use the correct route for your server

                        }


                                            // Highlight rows with "unpaid" status
                    if (applicant.status === 'unpaid') {
                        row.style.backgroundColor = 'yellow';
                    }


                row.innerHTML = `
                    <td>${index+1}</td>
                    <td>${applicant.appl_no}</td>
                    <td>${applicant.appl_date}</td>
                    <td>${applicant.name}</td>
                    <td>${applicant.gender}</td>
                    <td>${applicant.email}</td>
                    <td>${applicant.dateOfBirth}</td>
                    <td>${applicant.phoneNumber}</td>
                    <td>${applicant.from_date}</td>
                    <td>$                     </td>
                    <td>$                     </td>
                    <td>${applicant.expiry_date}</td>
                    <td>${applicant.whatsappNumber}</td>
                    <td>${applicant.panCardNumber}</td>
                    <td>${applicant.aadhaarNumber}</td>
                    <td>${applicant.currentAddress}</td>
                    <td>${applicant.landmark}</td>
                    <td>${applicant.area}</td>
                    <td>${applicant.pinCode}</td>
                    <td>${applicant.city}</td>
                    <td>${applicant.state}</td> 
                    <td>${applicant.country}</td>
                    <td>${applicant.sameAddress}</td>
                    <td>${applicant.permanentAddress}</td>                    
                    <td>${applicant.foreignNational}</td>
                    <td>${applicant.pepStatus}</td>
                    <td>${applicant.bankName}</td>
                    <td>${applicant.accountNumber}</td>
                    <td>${applicant.MICR}</td>
                    <td>${applicant.ifscCode}</td>
                    <td>${applicant.accountType}</td>
                    <td>${applicant.branchAddress}</td>
                    <td>${applicant.nomineeName}</td>
                    <td>${applicant.nomineeDOB}</td>
                    <td>${applicant.nomineeGender}</td>
                    <td>${applicant.nomineeRelationship}</td>
                    <td>${applicant.nomineePhoneNumber}</td>
                    <td>${applicant.appointeeName}</td>
                    <td>${applicant.appointeeRelationship}</td>
                    <td>${applicant.paymentMode}</td>
                    <td>${applicant.amount}</td>
                    <td>${applicant.planSelection}</td>
                    <td>${applicant.subscriptionOption}</td>
                    <td>${schemeName}</td>
                    <td>${tenure}</td>
                    <td>${lockIn}</td>
                    <td>${interest}</td>
                    <td>${loyaltyBonus}</td>  
                    <td>$              </td>
                    <td>${applicant.payor_name}</td>
                    <td>${applicant.payor_relation}</td>
                    <td>${applicant.payor_phone}</td>
                    <td>${applicant.payor_email}</td>
                    <td>${applicant.opt_option}</td>
                    <td>${applicant.with_name}</td>
                    <td>${applicant.with_relationship}</td>
                    <td>${applicant.with_address}</td>
                    <td>${applicant.with_landmark}</td>
                    <td>${applicant.with_pincode}</td>
                    <td>${applicant.with_city}</td>
                    <td>${applicant.with_state}</td>
                    <td>${applicant.with_country}</td>
                   <td>${applicant.terms_accepted}</td>
                    <td>${applicant.status}</td>
                    <td><button onclick="createInstallment(${applicant.appl_no})">Create Installment</button>
                     </td>
                `;
                tableBody.appendChild(row);
            });
        }
    })
    .catch(err => console.error(err));

        function downloadExcel() {
            window.location.href = '/download-excel';
        }
        function handleRowClick(applicant) {
}
function createInstallment(applicantId) {
            // Make a POST request to create the installment
            fetch(`/installments/${applicantId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ /* Your installment data */ })
            })
            .then(response => {
                if (response.ok) {
                    showToast('Installment created successfully');
                } else {
                    throw new Error('Failed to create installment');
                }
            })
            .catch(error => {
                console.error('Error creating installment:', error);
                showToast('Failed to create installment');
            });
        }




fetch('/expiry-user')
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector('#expiryUsersTable tbody');
        const noDataMessage = document.getElementById('noExpiryUsersMessage');

        // Clear previous data
        tableBody.innerHTML = '';

        if (data.length === 0) {
            noDataMessage.style.display = 'block'; // Show the no data message
        } else {
            noDataMessage.style.display = 'none'; // Hide no data message
            data.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.expiry_date}</td>
                `;
                tableBody.appendChild(row);
            });
        }
    })
    .catch(err => console.error(err));




    // First, fetch the appl_no from the applicant table
db.get("SELECT appl_no FROM applicant WHERE appl_no = ?", [yourApplNo], function(err, row) {
    if (err) {
        console.error(err);
        return;
    }

    if (row) {
        let appl_no = row.appl_no;

        // Fetch the due_date for the first and last installment for this appl_no
        db.all(`
            SELECT due_date FROM installment
            WHERE appl_no = ? 
            ORDER BY installment_id ASC
        `, [appl_no], function(err, rows) {
            if (err) {
                console.error(err);
                return;
            }

            if (rows.length > 0) {
                // Get the start_date (first installment due_date)
                let start_date = rows[0].due_date;

                // Get the end_date (last installment due_date)
                let end_date = rows[rows.length - 1].due_date;

                // Update the applicant table with the start_date and end_date
                db.run(`
                    UPDATE applicant
                    SET start_date = ?, end_date = ?
                    WHERE appl_no = ?
                `, [start_date, end_date, appl_no], function(err) {
                    if (err) {
                        console.error(err);
                    } else {
                        console.log('Applicant table updated with start_date and end_date');
                    }
                });
            } else {
                console.log('No installments found for this applicant');
            }
        });
    } else {
        console.log('Applicant not found');
    }
});



















    </script>
</body>
</html>
